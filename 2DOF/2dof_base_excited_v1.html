<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Stressjock's Pro 2DOF - Modal & Phase Analyzer</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

<style>
body{ margin:0; background:#03436c; font-family:Segoe UI,Arial; }
header{ background:#0b64a0; color:#fff; padding:10px 14px; }
main{ display:flex; gap:12px; padding:12px; max-width:1400px; margin:auto; }
.panel{ background:#fff; padding:12px; border-radius:6px; }
.controls{ width:420px; }
.plot-panel{ flex:1; min-width:500px; display: flex; flex-direction: column; gap: 15px; }
.row{margin-bottom:10px}
label{font-size:12px;font-weight:600}
input[type=number]{width:95px}
input[type=range]{width:100%}
.notes{ font-size:12px; line-height:1.4; margin-top:12px; color:#222; border-top:1px solid #ddd; padding-top:8px; }
#results { margin-top: 10px; padding: 12px; background: #f8f9fa; border-left: 4px solid #0b64a0; font-size: 13px; }
.res-line { margin-bottom: 6px; padding-bottom: 4px; border-bottom: 1px solid #eee; }
svg text { font-size: 15px; font-family: Segoe UI, Arial; font-weight: 500; }
.svg-bold { font-weight: bold; font-size: 16px; }
.canvas-container { position: relative; height: 260px; width: 100%; }
.toggle-row { display: flex; flex-direction: column; gap: 4px; margin-bottom: 15px; font-size: 13px; color: #03436c; font-weight: bold; }
select.scale-select { padding: 4px; border-radius: 4px; border: 1px solid #ccc; width: 100%; }
</style>
</head>

<body>
<header><b>Stressjock's Pro 2DOF: Full Modal & Transmissibility Solver</b></header>

<main>
<div class="panel controls">
  <div class="row">
    <label>Units</label><br>
    <select id="units" style="width:100%">
      <option value="metric">Metric (kg, N/m, N·s/m)</option>
      <option value="english">English (lbm, lbf/in, lbf·s/in)</option>
    </select>
  </div>

  <div class="toggle-row">
    <label for="scaleType">Chart Scaling</label>
    <select id="scaleType" class="scale-select">
      <option value="linear-linear">Linear (Linear X / Linear Y)</option>
      <option value="linear-log">Semi-Log (Linear X / Log Y)</option>
      <option value="log-log">Log-Log (Log X / Log Y)</option>
    </select>
  </div>

  <div class="row"><label>Mass m₁</label><input id="m1S" type="range" min="0.1" max="20" step="0.1" value="1.0"><input id="m1I" type="number" value="1.0"></div>
  <div class="row"><label>Mass m₂ (Tuned Mass)</label><input id="m2S" type="range" min="0" max="10" step="0.05" value="0.5"><input id="m2I" type="number" value="0.5"></div>
  <div class="row"><label>Stiffness k₁</label><input id="k1S" type="range" min="100" max="100000" step="100" value="20000"><input id="k1I" type="number" value="20000"></div>
  <div class="row"><label>Stiffness k₂</label><input id="k2S" type="range" min="0" max="100000" step="100" value="15000"><input id="k2I" type="number" value="15000"></div>
  <div class="row"><label>Damping c₁</label><input id="c1S" type="range" min="0" max="500" step="1" value="40"><input id="c1I" type="number" value="40"></div>
  <div class="row"><label>Damping c₂</label><input id="c2S" type="range" min="0" max="500" step="1" value="25"><input id="c2I" type="number" value="25"></div>

  <div id="results">
    <div id="m1_line" class="res-line"><strong>Mode 1:</strong> <span id="m1_data">-</span></div>
    <div id="m2_line" class="res-line"><strong>Mode 2:</strong> <span id="m2_data">-</span></div>
    <div style="font-size:12px; color:#555;">Ref. Frequency (m₁ alone): <span id="wn1_val">-</span></div>
  </div>

  <svg viewBox="0 0 280 280" width="100%" height="240" style="margin-top:15px; background: #fafafa; border-radius: 4px;">
    <defs>
      <marker id="arrow" markerWidth="10" markerHeight="10" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6 Z" fill="#d7191c" /></marker>
      <marker id="arrow-blue" markerWidth="10" markerHeight="10" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6 Z" fill="#2b83ba" /></marker>
      <marker id="arrow-base" markerWidth="10" markerHeight="10" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6 Z" fill="#333" /></marker>
    </defs>
    <rect x="90" y="20" width="100" height="40" fill="#ffe4c4" stroke="#333" stroke-width="2"/>
    <text x="140" y="46" text-anchor="middle" class="svg-bold">m₂</text>
    <line x1="210" y1="55" x2="210" y2="25" stroke="#d7191c" stroke-width="2" marker-end="url(#arrow)" />
    <text x="220" y="45" fill="#d7191c" font-weight="bold">x₂</text>
    <line x1="140" y1="60" x2="140" y2="100" stroke="#666" stroke-width="2" stroke-dasharray="4,2" />
    <text x="150" y="85" fill="#666" style="font-size:13px">k₂, c₂</text>
    <rect x="90" y="100" width="100" height="40" fill="#cfe8ff" stroke="#333" stroke-width="2"/>
    <text x="140" y="126" text-anchor="middle" class="svg-bold">m₁</text>
    <line x1="210" y1="135" x2="210" y2="105" stroke="#2b83ba" stroke-width="2" marker-end="url(#arrow-blue)" />
    <text x="220" y="125" fill="#2b83ba" font-weight="bold">x₁</text>
    <line x1="140" y1="140" x2="140" y2="180" stroke="#666" stroke-dasharray="4,2" stroke-width="2" />
    <text x="150" y="165" fill="#666" style="font-size:13px">k₁, c₁</text>
    <rect x="60" y="180" width="160" height="15" fill="#999" />
    <line x1="240" y1="195" x2="240" y2="165" stroke="#333" stroke-width="2" marker-end="url(#arrow-base)" />
    <text x="250" y="185" fill="#333" font-weight="bold">y</text>
    <text x="140" y="215" text-anchor="middle" font-style="italic">Base Excitation y(t)</text>
  </svg>
</div>

<div class="panel plot-panel">
  <div class="canvas-container"><canvas id="ampPlot"></canvas></div>
  <div class="canvas-container"><canvas id="phasePlot"></canvas></div>
  <div class="canvas-container"><canvas id="modalPlot"></canvas></div>
  
  <div class="notes">
    <b>Engineering Notes:</b><br>
    • <b>Plotted Quantities:</b> |X₁/Y| and |X₂/Y| are the absolute displacement transmissibilities.<br>
    • <b>X-Axis (r):</b> Frequency ratio relative to uncoupled primary system \( \omega_{n1} = \sqrt{k_1/m_1} \).<br>
    • <b>Phase Lag:</b> Measured relative to base motion \( y(t) \). A phase of -90° typically indicates resonance.<br>
    • <b>Modal Participation:</b> Shows the fraction of total response magnitude contributed by each mode (\( |q_j| / \sum |q_i| \)). This identifies which mode "owns" the energy at a given frequency.<br>
    • <b>SDOF Fallback:</b> If \( m_2 \) or \( k_2 \) is 0, logic switches to standard 1-DOF model.<br>
    • <b>Tuning:</b> To use as a TMD, set \( \sqrt{k_2/m_2} \) close to the target problem frequency.
  </div>
</div>
</main>

<script>
const IN=0.0254, LBM=0.453592, LBF=4.44822;
const C=(r,i)=>({r,i});
const mul=(a,b)=>C(a.r*b.r-a.i*b.i,a.r*b.i+a.i*b.r);
const sub=(a,b)=>C(a.r-b.r,a.i-b.i);
const div=(a,b)=>{const d=b.r*b.r+b.i*b.i;return C((a.r*b.r+a.i*b.i)/d,(a.i*b.r-a.r*b.i)/d);}
const mag=a=>Math.hypot(a.r,a.i);
const phase=a=>Math.atan2(a.i,a.r)*(180/Math.PI);

const g=id=>document.getElementById(id);
['m1','m2','k1','k2','c1','c2'].forEach(p=>{
  g(p+'S').oninput=()=>{g(p+'I').value=g(p+'S').value;run();}
  g(p+'I').oninput=()=>{g(p+'S').value=g(p+'I').value;run();}
});
g('units').onchange=run;
g('scaleType').onchange=run;

const commonOpts = { maintainAspectRatio: false, animation: false, plugins: { tooltip: { mode: 'index', intersect: false } } };

const ampChart=new Chart(g('ampPlot'),{
  type:'scatter',
  data:{ datasets:[
    {label:'Mass 1 |X₁/Y|', data:[], borderColor:'#2b83ba', showLine:true, pointRadius:0, borderWidth:2.5},
    {label:'Mass 2 |X₂/Y|', data:[], borderColor:'#d7191c', showLine:true, pointRadius:0, borderWidth:2.5}
  ]},
  options:{ ...commonOpts, scales:{ x:{ display: false, min: 0.05, max:5 }, y:{ title:{display:true, text:'Transmissibility'}, min: 0.01 } } }
});

const phaseChart=new Chart(g('phasePlot'),{
  type:'scatter',
  data:{ datasets:[
    {label:'Phase X₁ (deg)', data:[], borderColor:'#2b83ba', showLine:true, pointRadius:0, borderWidth:2.5},
    {label:'Phase X₂ (deg)', data:[], borderColor:'#d7191c', showLine:true, pointRadius:0, borderWidth:2.5}
  ]},
  options:{ ...commonOpts, scales:{ x:{ display: false, min: 0.05, max:5 }, y:{ title:{display:true, text:'Phase Lag (deg)'}, min:-360, max:0, ticks: { stepSize: 90 } } } }
});

const modalChart = new Chart(g('modalPlot'), {
  type: 'line',
  data: { datasets: [
    { label: 'Mode 1 Contribution', data: [], backgroundColor: 'rgba(43, 131, 186, 0.4)', fill: true, pointRadius: 0, borderColor: '#2b83ba' },
    { label: 'Mode 2 Contribution', data: [], backgroundColor: 'rgba(215, 25, 28, 0.4)', fill: true, pointRadius: 0, borderColor: '#d7191c' }
  ]},
  options: { ...commonOpts, scales: { x: { type: 'linear', title: { display: true, text: 'Frequency Ratio r (ω / ωn1)' }, min: 0.05, max: 5 }, y: { stacked: true, title: { display: true, text: 'Modal Participation' }, min: 0, max: 1 } } }
});

function run() {
  let m1=+g('m1I').value, m2=+g('m2I').value, k1=+g('k1I').value, k2=+g('k2I').value, c1=+g('c1I').value, c2=+g('c2I').value;
  if(g('units').value==='english'){ m1*=LBM; m2*=LBM; k1*=LBF/IN; k2*=LBF/IN; c1*=LBF/IN; c2*=LBF/IN; }

  const wn1_ref = Math.sqrt(k1/m1);
  g('wn1_val').innerText = `${(wn1_ref/(2*Math.PI)).toFixed(2)} Hz (${wn1_ref.toFixed(1)} rad/s)`;

  const isSDOF = (m2 <= 0 || k2 <= 0);
  let eigVecs = [[1,0],[0,1]];

  if(!isSDOF) {
    g('m2_line').style.display = 'block';
    const a = m1 * m2, b = -(m1 * k2 + m2 * (k1 + k2)), c = k1 * k2;
    const roots = [(-b - Math.sqrt(b*b-4*a*c))/(2*a), (-b + Math.sqrt(b*b-4*a*c))/(2*a)];
    const sys_wn2 = roots;
    roots.forEach((w2, i) => {
      const rad = Math.sqrt(w2);
      g(`m${i+1}_data`).innerText = `${(rad/(2*Math.PI)).toFixed(2)} Hz (${rad.toFixed(1)} rad/s) at r ≈ ${(rad/wn1_ref).toFixed(2)}`;
      eigVecs[i] = [1, (k1 + k2 - m1 * w2) / k2]; 
    });
  } else {
    g('m1_data').innerText = `${(wn1_ref/(2*Math.PI)).toFixed(2)} Hz at r = 1.00`;
    g('m2_line').style.display = 'none';
  }

  const scale = g('scaleType').value;
  const d1=[], d2=[], rawP1=[], rawP2=[], mod1=[], mod2=[];
  const pts = 300;
  const detPhi = eigVecs[0][0]*eigVecs[1][1] - eigVecs[0][1]*eigVecs[1][0];

  for(let i=0; i<=pts; i++){
    let r = (scale === 'log-log') ? 0.05 * Math.pow(100, i/pts) : 0.05 + (4.95 * i) / pts;
    const w = r * wn1_ref;
    
    if(!isSDOF) {
      const Z11 = C(k1 + k2 - m1*w*w, w*(c1 + c2)), Z12 = C(-k2, -w*c2), Z22 = C(k2 - m2*w*w, w*c2), F = C(k1, w*c1);
      const det = sub(mul(Z11, Z22), mul(Z12, Z12));
      const X1 = div(mul(F, Z22), det), X2 = div(mul(C(-Z12.r, -Z12.i), F), det);
      d1.push({x: r, y: Math.max(0.001, mag(X1))}); d2.push({x: r, y: Math.max(0.001, mag(X2))});
      rawP1.push(phase(X1)); rawP2.push(phase(X2));
      
      const q1 = mag(C((eigVecs[1][1]*X1.r - eigVecs[1][0]*X2.r)/detPhi, (eigVecs[1][1]*X1.i - eigVecs[1][0]*X2.i)/detPhi));
      const q2 = mag(C((-eigVecs[0][1]*X1.r + eigVecs[0][0]*X2.r)/detPhi, (-eigVecs[0][1]*X1.i + eigVecs[0][0]*X2.i)/detPhi));
      mod1.push({x: r, y: q1/(q1+q2)}); mod2.push({x: r, y: q2/(q1+q2)});
    } else {
      const cX = div(C(k1, w*c1), C(k1 - m1*w*w, w*c1));
      d1.push({x: r, y: mag(cX)}); d2.push({x: r, y: 0});
      rawP1.push(phase(cX)); rawP2.push(null);
      mod1.push({x: r, y: 1}); mod2.push({x: r, y: 0});
    }
  }

  const unwrap = (arr) => {
    let out = [], last = arr[0], off = 0;
    arr.forEach((v, i) => {
      if (v === null) { out.push({x: d1[i].x, y: null}); return; }
      let diff = v - last;
      if (diff > 180) off -= 360; else if (diff < -180) off += 360;
      out.push({x: d1[i].x, y: v + off}); last = v;
    });
    return out;
  };

  const p1 = unwrap(rawP1), p2 = unwrap(rawP2);
  const xType = scale === 'log-log' ? 'logarithmic' : 'linear';
  const yType = (scale === 'linear-log' || scale === 'log-log') ? 'logarithmic' : 'linear';

  [ampChart, phaseChart, modalChart].forEach(c => c.options.scales.x.type = xType);
  ampChart.options.scales.y.type = yType;

  ampChart.data.datasets[0].data = d1; ampChart.data.datasets[1].data = d2;
  phaseChart.data.datasets[0].data = p1; phaseChart.data.datasets[1].data = p2;
  modalChart.data.datasets[0].data = mod1; modalChart.data.datasets[1].data = mod2;
  
  const minY = Math.min(...p1.map(v => v.y), ...p2.map(v => v.y || 0));
  phaseChart.options.scales.y.min = Math.floor(minY / 90) * 90 - 90;

  ampChart.update(); phaseChart.update(); modalChart.update();
}
run();
</script>
</body>
</html>